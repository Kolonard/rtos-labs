# Лабораторная работа №1: Основы работы с FreeRTOS. Виды многозадачности

## Цель работы

Научиться запускать FreeRTOS на платформе Win32, создавать задачи и исследовать поведение планировщика при различных режимах многозадачности и приоритетах задач.

---

## Важные замечания

### Вывод в консоль

Все эффекты, связанные с стурктурой многозадачности **не будут проявляться** при использовании стандартных способов вывода информации.
Для выввода текста в консоль, используйте `_printf()`.

``` c
static void _printf(uint8_t source, void *input_string); 
```

где

- `uint8_t source` - источник вызова. Должно быть `0` или `USER`;
- `void *input_string` - текстовая строка;

Пример использования функции `_printf()`:

```c
#include "lab_common.h" 
_printf(USER, void *input_string); 

```

---

## Задачи лабораторной работы

1. **Запуск FreeRTOS**  
   - Собрать и запустить демонстрационный проект FreeRTOS (Win32-порт).  
   - Убедиться, что FreeRTOS корректно стартует и выводит сообщения в консоль.

2. **Создание двух задач с одинаковыми приоритетами**  
   - Создать две простые задачи (`Task1` и `Task2`), которые выводят сообщения в консоль и делают небольшую задержку (`vTaskDelay`) порядка 10мс.

3. **Запуск FreeRTOS с этими задачами в режиме вытесняющей многозадачности**  

   - Настроить FreeRTOS на использование вытесняющей многозадачности (`configUSE_PREEMPTION = 1`).  
   - Наблюдать порядок выполнения задач.
   - Проанализировать, как задачи переключаются друг с другом при вытесняющей многозадачности.

4. **Запуск FreeRTOS с этими задачами в режиме последовательной (кооперативной) многозадачности без вызова `taskYIELD()`**  

   - Настроить FreeRTOS на кооперативный режим (`configUSE_PREEMPTION = 0`).  
   - Наблюдать порядок выполнения задач.
   - Проанализировать, как задачи переключаются друг с другом при кооперативной многозадачности.

5. **Запуск FreeRTOS с этими задачами в режиме последовательной многозадачности с использованием `taskYIELD()`**  
   - Вставить вызовы `taskYIELD()` в задачи.  
   - Наблюдать порядок выполнения задач.
   - Проанализировать, как задачи переключаются друг с другом при кооперативной многозадачности с передачей.

6. **Запуск FreeRTOS с этими задачами в режиме вытесняющей многозадачности с разными приоритетами**  
   - Назначить задачам разные приоритеты.  
   - Наблюдать, как планировщик распределяет время работы между задачами с разными приоритетами.

---

## Отчёт по лабораторной работе

Студенты должны предоставить:

- Собственный исходный код с реализованными задачами;
- Скриншоты или вывод консоли для каждого режима;
- Краткий анализ наблюдаемого поведения планировщика в каждом режиме.

---

## Приложение: Пример кода создания задачи и управление многозадачностью

### Минимальный пример создания задачи

```c
#include "FreeRTOS.h"
#include "task.h"
#include <stdio.h>
#include "lab_common.h"


#define PRINT_TIMEOUT 1000
#define SYMBOL_PRINT_TIMEOUT 10

static void _printf(uint8_t source, void *input_string) 
{
    const char *text = (const char *)input_string;
    for (size_t i = 0; i < strlen(text); i++)
    {
        putchar(text[i]);
        fflush(stdout);

        #if (configUSE_PREEMPTION == 1)
            if (source == OS) {
                vTaskDelay(pdMS_TO_TICKS(SYMBOL_PRINT_TIMEOUT));
            }
        #endif
    }
    printf("\n");
}

static void PrintTask(void *pvParameters)
{
    for(;;)
    {
        _printf(OS, pvParameters);
        #if (configUSE_PREEMPTION == 0)
            taskYIELD();
        #endif
    }
}

int main(void)
{
    // Создаём две задачи с разными текстами
    xTaskCreate(PrintTask, "Task1", 1000, "First task processing",   1, NULL);
    xTaskCreate(PrintTask, "Task2", 1000, "Second task operate",     1, NULL);

    // Запуск планировщика
    vTaskStartScheduler();

    for(;;); // планировщик никогда не вернётся сюда
    return 0;
}
```

---

## Настройка многозадачности в `FreeRTOSConfig.h`

Файл `FreeRTOSConfig.h` содержит можество параметров, определяющих поведение FreeRTOS. Описание ключевых полей приведено в таблице:

| Параметр                 | Описание                                                                         | Пример                             |
| ------------------------ | -------------------------------------------------------------------------------- | ---------------------------------- |
| `configUSE_PREEMPTION`   | Включает вытесняющую (1) или кооперативную (0) многозадачность                   | `#define configUSE_PREEMPTION 1`   |
| `configUSE_TIME_SLICING` | Включает равномерное распределение времени между задачами одинакового приоритета | `#define configUSE_TIME_SLICING 1` |
| `configTICK_RATE_HZ`     | Частота тиков планировщика                                                       | `#define configTICK_RATE_HZ 1000`  |
| `configMAX_PRIORITIES`   | Максимальное количество уровней приоритетов задач                                | `#define configMAX_PRIORITIES 5`   |

---

## Объяснение параметров xTaskCreate

`xTaskCreate()` - функция создания задачии во FreeRTOS.

``` c
 BaseType_t xTaskCreate( TaskFunction_t pvTaskCode,
                         const char * const pcName,
                         const configSTACK_DEPTH_TYPE uxStackDepth,
                         void *pvParameters,
                         UBaseType_t uxPriority,
                         TaskHandle_t *pxCreatedTask
                       );

```

| Параметр        | Описание                                                                                                                                    |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| `pvTaskCode`    | Указатель на функцию задачи (`void Task(void *pvParameters)`).                                                                              |
| `pcName`        | Имя задачи для отладки и мониторинга.                                                                                                       |
| `usStackDepth`  | Размер стека задачи в словах (для Win32 обычно достаточно 1000).                                                                            |
| `pvParameters`  | Указатель на данные, передаваемые в задачу (например, строка или структура).                                                                |
| `uxPriority`    | Приоритет задачи (0 = минимальный, чем выше, тем выше приоритет).                                                                           |
| `pxCreatedTask` | Указатель на хэндл задачи (`TaskHandle_t`), можно использовать для управления задачей после создания (например, удалить или приостановить). |

---

## Примечания по работе

### Путь до исполняемого файла

Расположенрие файла проекта `VS community` в стурктуре папок.

``` bash

{Путь до корня проекта}/rtos-labs/FreeRTOS/FreeRTOS/Demo/WIN32-MSVC/

```

### Клонирование проекта

Клонирование репозитория соостоит из этапов (для консольной версии [git-scm.com](https://git-scm.com/)):

0. Установть git;
1. В консоли перейти в папку предпологаемого хранени локальной копии репозитория;
2. Клонировать репозиторий командой

``` bash

git clone "https://github.com/Kolonard/rtos-labs/tree/main"

```
